<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>20 Iteration | Introduction to the principles of data wrangling and visualisation in R</title>
  <meta name="description" content="20 Iteration | Introduction to the principles of data wrangling and visualisation in R" />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="20 Iteration | Introduction to the principles of data wrangling and visualisation in R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://seankross.com/bookdown-start/" />
  
  
  <meta name="github-repo" content="seankross/bookdown-start" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="20 Iteration | Introduction to the principles of data wrangling and visualisation in R" />
  
  
  

<meta name="author" content="Dan Olner" />


<meta name="date" content="2021-08-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="facetting-and-dodging-getting-as-much-info-into-one-graph-as-humanly-possible.html"/>
<link rel="next" href="a-little-bit-of-mapping.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Introduction to the principles of data wrangling and visualisation in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="getting-r-and-rstudio.html"><a href="getting-r-and-rstudio.html"><i class="fa fa-check"></i><b>2</b> Getting R and RStudio</a></li>
<li class="chapter" data-level="3" data-path="r-studio.html"><a href="r-studio.html"><i class="fa fa-check"></i><b>3</b> R-Studio</a>
<ul>
<li class="chapter" data-level="3.1" data-path="r-studio.html"><a href="r-studio.html#a-first-look-at-rstudio"><i class="fa fa-check"></i><b>3.1</b> A first look at RStudio</a></li>
<li class="chapter" data-level="3.2" data-path="r-studio.html"><a href="r-studio.html#entering-commands-in-r"><i class="fa fa-check"></i><b>3.2</b> Entering commands in R</a></li>
<li class="chapter" data-level="3.3" data-path="r-studio.html"><a href="r-studio.html#assigning-to-variables"><i class="fa fa-check"></i><b>3.3</b> Assigning to variables</a></li>
<li class="chapter" data-level="3.4" data-path="r-studio.html"><a href="r-studio.html#opening-a-project-in-rstudio"><i class="fa fa-check"></i><b>3.4</b> Opening a project in RStudio</a></li>
<li class="chapter" data-level="3.5" data-path="r-studio.html"><a href="r-studio.html#creating-a-new-script-and-running-code-in-it"><i class="fa fa-check"></i><b>3.5</b> Creating a new script and running code in it</a></li>
<li class="chapter" data-level="3.6" data-path="r-studio.html"><a href="r-studio.html#but-will-it-make-sense-in-two-months-time-using-comments-and-sections"><i class="fa fa-check"></i><b>3.6</b> ‘But will it make sense in two month’s time…?’ Using comments and sections</a></li>
<li class="chapter" data-level="3.7" data-path="r-studio.html"><a href="r-studio.html#its-all-about-the-libraries"><i class="fa fa-check"></i><b>3.7</b> It’s all about the libraries</a></li>
<li class="chapter" data-level="3.8" data-path="r-studio.html"><a href="r-studio.html#loading-a-file-into-a-dataframe-and-examining-the-data"><i class="fa fa-check"></i><b>3.8</b> Loading a file into a dataframe and examining the data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="introduction-1.html"><a href="introduction-1.html"><i class="fa fa-check"></i><b>4</b> Introduction</a></li>
<li class="chapter" data-level="5" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>5</b> Getting started</a></li>
<li class="chapter" data-level="6" data-path="loading-the-libraries.html"><a href="loading-the-libraries.html"><i class="fa fa-check"></i><b>6</b> Loading the libraries</a></li>
<li class="chapter" data-level="7" data-path="loading-the-house-price-data.html"><a href="loading-the-house-price-data.html"><i class="fa fa-check"></i><b>7</b> Loading the house price data</a></li>
<li class="chapter" data-level="8" data-path="lets-jump-right-into-ggplot.html"><a href="lets-jump-right-into-ggplot.html"><i class="fa fa-check"></i><b>8</b> Let’s jump right into ggplot</a></li>
<li class="chapter" data-level="9" data-path="the-lubridate-library.html"><a href="the-lubridate-library.html"><i class="fa fa-check"></i><b>9</b> The lubridate library</a></li>
<li class="chapter" data-level="10" data-path="using-ggplots-own-stat-functions.html"><a href="using-ggplots-own-stat-functions.html"><i class="fa fa-check"></i><b>10</b> Using ggplot’s own stat functions</a></li>
<li class="chapter" data-level="11" data-path="getting-started-with-dplyr-and-piping.html"><a href="getting-started-with-dplyr-and-piping.html"><i class="fa fa-check"></i><b>11</b> Getting started with <strong>dplyr</strong> and <strong>piping</strong></a>
<ul>
<li class="chapter" data-level="11.1" data-path="getting-started-with-dplyr-and-piping.html"><a href="getting-started-with-dplyr-and-piping.html#piping"><i class="fa fa-check"></i><b>11.1</b> Piping!</a></li>
<li class="chapter" data-level="11.2" data-path="getting-started-with-dplyr-and-piping.html"><a href="getting-started-with-dplyr-and-piping.html#dplyrs-verbs"><i class="fa fa-check"></i><b>11.2</b> <strong>dplyr</strong>’s verbs</a></li>
<li class="chapter" data-level="11.3" data-path="getting-started-with-dplyr-and-piping.html"><a href="getting-started-with-dplyr-and-piping.html#and-a-few-extras-while-were-here"><i class="fa fa-check"></i><b>11.3</b> And a few extras while we’re here…</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="using-scales-to-control-appearance.html"><a href="using-scales-to-control-appearance.html"><i class="fa fa-check"></i><b>12</b> Using scales to control appearance</a></li>
<li class="chapter" data-level="13" data-path="scales-for-controlling-colour.html"><a href="scales-for-controlling-colour.html"><i class="fa fa-check"></i><b>13</b> Scales for controlling colour</a></li>
<li class="chapter" data-level="14" data-path="using-factors-to-control-order-of-variables.html"><a href="using-factors-to-control-order-of-variables.html"><i class="fa fa-check"></i><b>14</b> Using factors to control order of variables</a></li>
<li class="chapter" data-level="15" data-path="joining-data-sources-together.html"><a href="joining-data-sources-together.html"><i class="fa fa-check"></i><b>15</b> Joining data sources together</a>
<ul>
<li class="chapter" data-level="15.1" data-path="joining-data-sources-together.html"><a href="joining-data-sources-together.html#gathering-into-long-form"><i class="fa fa-check"></i><b>15.1</b> `Gathering’ into long form</a></li>
<li class="chapter" data-level="15.2" data-path="joining-data-sources-together.html"><a href="joining-data-sources-together.html#saving-and-reloading-the-housing-data"><i class="fa fa-check"></i><b>15.2</b> Saving and reloading the housing data</a></li>
<li class="chapter" data-level="15.3" data-path="joining-data-sources-together.html"><a href="joining-data-sources-together.html#merging-the-housing-and-wages-data"><i class="fa fa-check"></i><b>15.3</b> Merging the housing and wages data</a></li>
<li class="chapter" data-level="15.4" data-path="joining-data-sources-together.html"><a href="joining-data-sources-together.html#choosing-a-subset-based-on-some-criterion"><i class="fa fa-check"></i><b>15.4</b> Choosing a subset based on some criterion</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="saving-ggplots-as-image-files.html"><a href="saving-ggplots-as-image-files.html"><i class="fa fa-check"></i><b>16</b> Saving ggplots as image files</a>
<ul>
<li class="chapter" data-level="16.1" data-path="saving-ggplots-as-image-files.html"><a href="saving-ggplots-as-image-files.html#time-for-a-pause"><i class="fa fa-check"></i><b>16.1</b> Time for a pause!</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="six-and-a-bit-options.html"><a href="six-and-a-bit-options.html"><i class="fa fa-check"></i><b>17</b> SIX (and a bit) OPTIONS</a></li>
<li class="chapter" data-level="18" data-path="prettifying-a-graph.html"><a href="prettifying-a-graph.html"><i class="fa fa-check"></i><b>18</b> Prettifying a graph</a></li>
<li class="chapter" data-level="19" data-path="facetting-and-dodging-getting-as-much-info-into-one-graph-as-humanly-possible.html"><a href="facetting-and-dodging-getting-as-much-info-into-one-graph-as-humanly-possible.html"><i class="fa fa-check"></i><b>19</b> Facetting and dodging: getting as much info into one graph as humanly possible</a></li>
<li class="chapter" data-level="20" data-path="iteration.html"><a href="iteration.html"><i class="fa fa-check"></i><b>20</b> Iteration</a>
<ul>
<li class="chapter" data-level="20.1" data-path="iteration.html"><a href="iteration.html#outputting-multiple-plots"><i class="fa fa-check"></i><b>20.1</b> 1. Outputting multiple plots</a></li>
<li class="chapter" data-level="20.2" data-path="iteration.html"><a href="iteration.html#pulling-out-multiple-model-values-and-visualising-them"><i class="fa fa-check"></i><b>20.2</b> 2. Pulling out multiple model values and visualising them</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="a-little-bit-of-mapping.html"><a href="a-little-bit-of-mapping.html"><i class="fa fa-check"></i><b>21</b> A little bit of mapping</a>
<ul>
<li class="chapter" data-level="21.1" data-path="a-little-bit-of-mapping.html"><a href="a-little-bit-of-mapping.html#one-simple-way-to-use-ggplot-for-mapping-the-2d-geoms"><i class="fa fa-check"></i><b>21.1</b> One simple way to use ggplot for mapping: the 2D geoms</a></li>
<li class="chapter" data-level="21.2" data-path="a-little-bit-of-mapping.html"><a href="a-little-bit-of-mapping.html#using-cowplot-to-get-around-the-facetting-problem"><i class="fa fa-check"></i><b>21.2</b> Using cowplot to get around the facetting problem</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="making-a-map-using-the-simple-features-library-tmap-and-a-bit-of-wrangling.html"><a href="making-a-map-using-the-simple-features-library-tmap-and-a-bit-of-wrangling.html"><i class="fa fa-check"></i><b>22</b> Making a map using the simple features library, tmap and a bit of wrangling</a></li>
<li class="chapter" data-level="23" data-path="a-last-little-ggplot-mapping-example.html"><a href="a-last-little-ggplot-mapping-example.html"><i class="fa fa-check"></i><b>23</b> A last little ggplot mapping example</a></li>
<li class="chapter" data-level="24" data-path="data-sources.html"><a href="data-sources.html"><i class="fa fa-check"></i><b>24</b> Data sources</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Introduction to the principles of data wrangling and visualisation in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="iteration" class="section level1" number="20">
<h1><span class="header-section-number">20</span> Iteration</h1>
<hr />
<div id="outputting-multiple-plots" class="section level2" number="20.1">
<h2><span class="header-section-number">20.1</span> 1. Outputting multiple plots</h2>
<p>It’s often useful to be able to look at many different elements of your data in their own separate plots - for example, looking at each city/town or local authority separately. This isn’t often the kind of task you might need for <strong>presenting data</strong> - but as a way to <strong>understand your own data</strong>, being able to output many plots easily is really useful.</p>
<blockquote>
<p><strong>One option is to use a for-loop to do this. This will allow us to loop over each plot we want and output them separately.</strong></p>
</blockquote>
<blockquote>
<p>What we’ll do here: <strong>cut up the local authorities from the work done in the <em>joining-data section</em> into equal size groups</strong> and plot each of the groups.</p>
</blockquote>
<p>We can work with the list of local authorities in price_n_wage2018. As usual, the tidyverse supplies a feature for cutting numeric data up in various ways.</p>
<hr />
<p><strong>If you haven’t still got <em>price_n_wage</em> and <em>price_n_wage2018</em> in memory from the join section, here’s the <em>price_n_wage</em> dataframe with code for re-grabbing just 2018.</strong></p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="iteration.html#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">#reload price_n_wage data we previously made</span></span>
<span id="cb207-2"><a href="iteration.html#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="co">#if it&#39;s been over-written with anything or removed</span></span>
<span id="cb207-3"><a href="iteration.html#cb207-3" aria-hidden="true" tabindex="-1"></a>price_n_wage <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;data/price_n_wage_fromjoinsection.rds&#39;</span>)</span>
<span id="cb207-4"><a href="iteration.html#cb207-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-5"><a href="iteration.html#cb207-5" aria-hidden="true" tabindex="-1"></a>price_n_wage2018 <span class="ot">&lt;-</span> price_n_wage <span class="sc">%&gt;%</span> </span>
<span id="cb207-6"><a href="iteration.html#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2018</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb207-7"><a href="iteration.html#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>wagemultiple)</span></code></pre></div>
<hr />
<p><strong>So how to cut up the local authority data into equal size groups? Here’s code that does that in two forms: the first is base R, the second uses the pipe operator in dplyr</strong> - just to compare legibility between the two.</p>
<p><strong>There’s very useful auto-help for the cut functions: if you just type <em>cut_</em>, this should appear. Each of the three cut functions is explained.</strong> <strong>cut_number</strong> will create a column marking out which rows for <strong>wagemultiple</strong> are in each group:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="iteration.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Base R version</span></span>
<span id="cb208-2"><a href="iteration.html#cb208-2" aria-hidden="true" tabindex="-1"></a>price_n_wage2018<span class="sc">$</span>groupToPrint <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">cut_number</span>(price_n_wage2018<span class="sc">$</span>wagemultiple,<span class="dv">8</span>))</span>
<span id="cb208-3"><a href="iteration.html#cb208-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-4"><a href="iteration.html#cb208-4" aria-hidden="true" tabindex="-1"></a><span class="co">#dplyr piping version, same result</span></span>
<span id="cb208-5"><a href="iteration.html#cb208-5" aria-hidden="true" tabindex="-1"></a>price_n_wage2018 <span class="ot">&lt;-</span> price_n_wage2018 <span class="sc">%&gt;%</span> </span>
<span id="cb208-6"><a href="iteration.html#cb208-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">groupToPrint =</span> wagemultiple <span class="sc">%&gt;%</span></span>
<span id="cb208-7"><a href="iteration.html#cb208-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">cut_number</span>(<span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb208-8"><a href="iteration.html#cb208-8" aria-hidden="true" tabindex="-1"></a>           as.numeric</span>
<span id="cb208-9"><a href="iteration.html#cb208-9" aria-hidden="true" tabindex="-1"></a>         )</span></code></pre></div>
<p>Note: the <strong>cut</strong> functions are <em>not</em> cutting according to row - it’s done according to value. That’s why group number one is <em>lowest-value</em> local authorities and eight the <em>highest</em>.</p>
<p>Get a list of the unique values we’re going to iterate over. <strong>This could be a vector of character names like place-names</strong> - it wouldn’t have to be numeric.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="iteration.html#cb209-1" aria-hidden="true" tabindex="-1"></a>groupsToPrint <span class="ot">&lt;-</span> <span class="fu">unique</span>(price_n_wage2018<span class="sc">$</span>groupToPrint)</span>
<span id="cb209-2"><a href="iteration.html#cb209-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-3"><a href="iteration.html#cb209-3" aria-hidden="true" tabindex="-1"></a>groupsToPrint</span></code></pre></div>
<pre><code>## [1] 8 7 6 5 4 3 2 1</code></pre>
<blockquote>
<p><strong>Now we’re going to loop over those eight groups and produce a plot for each.</strong></p>
</blockquote>
<blockquote>
<p><strong>If you’ve not come across <em>for-loops</em> before, they’re straightforward. Translated to English, for-loops are just: ‘for each of this set of values (in our case, it’ll be our eight groups), carry out this bunch of tasks, once per value’.</strong></p>
</blockquote>
<p>That vector can now be used in the for loop. <strong>Set up the for loop first just to see what it’s doing:</strong></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="iteration.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(grp <span class="cf">in</span> groupsToPrint){</span>
<span id="cb211-2"><a href="iteration.html#cb211-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-3"><a href="iteration.html#cb211-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(grp)</span>
<span id="cb211-4"><a href="iteration.html#cb211-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-5"><a href="iteration.html#cb211-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The for-loop <strong>assigns each value from <em>groupsToPrint</em> to the <em>grp</em> variable in turn</strong>. It then executes the code between the curly braces. In this case, we’re just printing the grp number - <strong>but the principle is the same for whatever code we put between them. We just need to replace <em>print(grp)</em> with our code.</strong></p>
<p>The first job for the loop: <strong>pull out the list of local authorities to print on each iteration</strong>. We <strong>filter by group</strong> and then <strong>pull</strong> out the single vector of local authorities in the <strong>Area</strong> variable (we also use <strong>print</strong> here so the result is visible in the for loop):</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="iteration.html#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(grp <span class="cf">in</span> groupsToPrint){</span>
<span id="cb212-2"><a href="iteration.html#cb212-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-3"><a href="iteration.html#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get vector of zones to draw</span></span>
<span id="cb212-4"><a href="iteration.html#cb212-4" aria-hidden="true" tabindex="-1"></a>  zoneselection <span class="ot">&lt;-</span> price_n_wage2018 <span class="sc">%&gt;%</span> </span>
<span id="cb212-5"><a href="iteration.html#cb212-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(groupToPrint <span class="sc">==</span> grp) <span class="sc">%&gt;%</span> </span>
<span id="cb212-6"><a href="iteration.html#cb212-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(Area)</span>
<span id="cb212-7"><a href="iteration.html#cb212-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-8"><a href="iteration.html#cb212-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(zoneselection)</span>
<span id="cb212-9"><a href="iteration.html#cb212-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-10"><a href="iteration.html#cb212-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>A couple of things before starting:</p>
<blockquote>
<p><strong>We’ll add our plots to a sub-folder in the images folder. Make that now with RStudio’s ‘new folder’ option in the file tab, inside the images folder: something like <em>groupsOfLocalAuthorities</em>.</strong></p>
</blockquote>
<blockquote>
<p><strong>It’s tricky trying to debug code that’s running inside a for loop. A useful thing to do is: pick one value to assign to <em>grp</em> so that we can then run the code by highlighting, without having to run the whole for loop. For example:</strong></p>
</blockquote>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="iteration.html#cb213-1" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">&lt;-</span> <span class="dv">1</span></span></code></pre></div>
<p>When we run the actual for loop, it will overwrite this with the value it assigns. But we can work with it while getting the code right.</p>
<p>There’s nothing much new in the code below: this is just our previous wage multiple plot code, working on each group in turn. The only other thing to note:</p>
<blockquote>
<p><strong>At the bottom, we’re making a filename that includes the first and last <em>local authority</em> names in the group (as well as the group name). This is done with the <em>paste0</em> function. <em>Paste0</em> just takes in a bunch of bits of text and variables, separated by commas, and turns them into one character. This allows us to save each group as its own file.</strong></p>
</blockquote>
<blockquote>
<p>There is also an added <strong>geom_point</strong> showing the median wage itself.</p>
</blockquote>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="iteration.html#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(grp <span class="cf">in</span> groupsToPrint){</span>
<span id="cb214-2"><a href="iteration.html#cb214-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-3"><a href="iteration.html#cb214-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&#39;outputting group &#39;</span>,grp))</span>
<span id="cb214-4"><a href="iteration.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-5"><a href="iteration.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get vector of zones to draw</span></span>
<span id="cb214-6"><a href="iteration.html#cb214-6" aria-hidden="true" tabindex="-1"></a>  zoneselection <span class="ot">&lt;-</span> price_n_wage2018 <span class="sc">%&gt;%</span> </span>
<span id="cb214-7"><a href="iteration.html#cb214-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(groupToPrint <span class="sc">==</span> grp) <span class="sc">%&gt;%</span> </span>
<span id="cb214-8"><a href="iteration.html#cb214-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(Area)</span>
<span id="cb214-9"><a href="iteration.html#cb214-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-10"><a href="iteration.html#cb214-10" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(price_n_wage <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Area <span class="sc">%in%</span> zoneselection),</span>
<span id="cb214-11"><a href="iteration.html#cb214-11" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> wagemultiple, <span class="at">colour =</span> <span class="fu">fct_reorder</span>(Area,<span class="sc">-</span>wagemultiple))) <span class="sc">+</span></span>
<span id="cb214-12"><a href="iteration.html#cb214-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> medianwage), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb214-13"><a href="iteration.html#cb214-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb214-14"><a href="iteration.html#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb214-15"><a href="iteration.html#cb214-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">&#39;area&#39;</span>)</span>
<span id="cb214-16"><a href="iteration.html#cb214-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-17"><a href="iteration.html#cb214-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save the plot</span></span>
<span id="cb214-18"><a href="iteration.html#cb214-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#text of zones</span></span>
<span id="cb214-19"><a href="iteration.html#cb214-19" aria-hidden="true" tabindex="-1"></a>  zonetext <span class="ot">&lt;-</span> <span class="fu">paste0</span>(zoneselection[<span class="dv">1</span>],<span class="st">&#39;_to_&#39;</span>,zoneselection[<span class="fu">length</span>(zoneselection)])</span>
<span id="cb214-20"><a href="iteration.html#cb214-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-21"><a href="iteration.html#cb214-21" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;images/groupsOfLocalAuthorities/group_&#39;</span>,grp,<span class="st">&#39;_&#39;</span>,zonetext,<span class="st">&#39;.png&#39;</span>)</span>
<span id="cb214-22"><a href="iteration.html#cb214-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-23"><a href="iteration.html#cb214-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(filename, output, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb214-24"><a href="iteration.html#cb214-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-25"><a href="iteration.html#cb214-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
</div>
<div id="pulling-out-multiple-model-values-and-visualising-them" class="section level2" number="20.2">
<h2><span class="header-section-number">20.2</span> 2. Pulling out multiple model values and visualising them</h2>
<p>This section is inspired by code from the excellent book <a href="http://r4ds.had.co.nz/">R for Data Science</a> and the section on mapping with the <strong>purrr</strong> library (another one that comes packaged with the <strong>tidyverse library</strong>).</p>
<p>Academic papers are still full of endless regression tables. They are not very aesthetically pleasing. Another option is to <strong>visualise your model’s findings</strong> in some way.</p>
<p>This section gives an example - it has little statistical merit but illustrates the basic idea:</p>
<blockquote>
<p><strong>If you’re running any kind of model on multiple subsets of data, how can you pull out the results of interest and visualise them? How do you also show error?</strong></p>
</blockquote>
<p><strong>ggplot</strong> has a number of geometries specifically for showing ranges - as well as showing error, these can be used for e.g. showing mins and maxes. <strong>You must set the values for these yourself</strong></p>
<blockquote>
<p><strong>The basic principle here is simple: pull out all of the results you want into a dataframe, then apply your dplyr and ggplot knowledge to visualise it and create error values</strong></p>
</blockquote>
<hr />
<p><strong>We’d expect employment and house prices to have a positive relationship but what’s the magnitude of the relationship, how much does it vary between places and has it changed over time?</strong></p>
<p>To look at this, <strong>we’ll combine house price data with employment data</strong> so that we have these in their own columns:</p>
<ul>
<li><strong>Average house price per ward for a range of TTWAs, for 2001 and 2011</strong></li>
<li><strong>Percent of employed people in those wards for 2001 and 2011</strong></li>
</ul>
<p>We’ll look at the same house price data, but this version is subsetted to:</p>
<blockquote>
<p><strong>2001 and 2011 so we can compare to employment data from the Censuses in those years.</strong>
<strong>Only TTWAs that have wards with 30 or more sales in each time period.</strong></p>
</blockquote>
<hr />
<p>If you like, <strong>there’s the option of skipping ahead a few steps and just loading the pre-prepared data</strong> for the regressions. Otherwise, <strong>let’s start by loading another subset of the sales data</strong>:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="iteration.html#cb215-1" aria-hidden="true" tabindex="-1"></a>sales <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;data/sales2001and2011wardsWithMoreThan30sales.rds&#39;</span>)</span>
<span id="cb215-2"><a href="iteration.html#cb215-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-3"><a href="iteration.html#cb215-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Note it&#39;s already got year in</span></span>
<span id="cb215-4"><a href="iteration.html#cb215-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sales)</span></code></pre></div>
<pre><code>##  [1] &quot;price&quot;              &quot;date&quot;               &quot;postcode&quot;          
##  [4] &quot;type&quot;               &quot;Eastings&quot;           &quot;Northings&quot;         
##  [7] &quot;wardcode&quot;           &quot;ttwa&quot;               &quot;ttwa_code&quot;         
## [10] &quot;localauthority&quot;     &quot;localauthoritycode&quot; &quot;year&quot;</code></pre>
<p>And this is the employment data: the columns <strong>2001</strong> and <strong>2011</strong> contain the <strong>percent of economically active people in employment</strong> in that ward.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="iteration.html#cb217-1" aria-hidden="true" tabindex="-1"></a>employment <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/percentEmployedByWard2001n2011.csv&#39;</span>)</span></code></pre></div>
<p>Now, as before, the job is just to:</p>
<ul>
<li><strong>summarise the housing data: average price per ward and per year</strong> - with the added detail that we want to <strong>keep the TTWA name these wards are in.</strong></li>
<li><strong>Join this summary with the employment data</strong>, linking on <strong>year</strong> and <strong>ward</strong>.</li>
</ul>
<p>Notice the trick used in <strong>summarise</strong> here to keep the TTWA name in the summary: <strong>using max(ttwa)</strong>. What does this do? In short: it’s a way of easily grabbing a column we want in our summary, if we know there’s a single value per group. (The <strong>sales</strong> dataframe has already had its wards set to only be in one TTWA.)</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="iteration.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Average price per ward per year</span></span>
<span id="cb218-2"><a href="iteration.html#cb218-2" aria-hidden="true" tabindex="-1"></a>priceSummary <span class="ot">&lt;-</span> sales <span class="sc">%&gt;%</span> </span>
<span id="cb218-3"><a href="iteration.html#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year,wardcode) <span class="sc">%&gt;%</span> </span>
<span id="cb218-4"><a href="iteration.html#cb218-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanprice =</span> <span class="fu">mean</span>(price), <span class="at">count =</span><span class="fu">n</span>(), <span class="at">ttwa =</span><span class="fu">max</span>(ttwa))</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;year&#39;. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="iteration.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">#p.s. if we wanted to find the modal ttwa, we could use this.</span></span>
<span id="cb220-2"><a href="iteration.html#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ttwa = names(which.max(table(ttwa))</span></span></code></pre></div>
<p>As the <strong>employment</strong> data has one column for each year, this has to be <strong>made into long-form.</strong> The two can then be <strong>joined</strong> using inner_join again to keep only wards common to both:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="iteration.html#cb221-1" aria-hidden="true" tabindex="-1"></a>empLong <span class="ot">&lt;-</span> employment <span class="sc">%&gt;%</span> </span>
<span id="cb221-2"><a href="iteration.html#cb221-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> year, <span class="at">value =</span> percentEmployed, <span class="st">`</span><span class="at">2001</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2011</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb221-3"><a href="iteration.html#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year))</span>
<span id="cb221-4"><a href="iteration.html#cb221-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-5"><a href="iteration.html#cb221-5" aria-hidden="true" tabindex="-1"></a>avpriceplusemp <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(priceSummary,empLong,</span>
<span id="cb221-6"><a href="iteration.html#cb221-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;year&#39;</span>,<span class="st">&#39;wardcode&#39;</span>))</span>
<span id="cb221-7"><a href="iteration.html#cb221-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-8"><a href="iteration.html#cb221-8" aria-hidden="true" tabindex="-1"></a><span class="co">#count of wards per ttwa / year</span></span>
<span id="cb221-9"><a href="iteration.html#cb221-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(avpriceplusemp<span class="sc">$</span>ttwa, avpriceplusemp<span class="sc">$</span>year)</span></code></pre></div>
<pre><code>##                           
##                            2001 2011
##   Blackburn                  50   50
##   Bradford                   32   32
##   Brighton                   54   54
##   Cambridge                  67   67
##   Doncaster                  21   21
##   Hull                       61   61
##   London                    926  926
##   Middlesbrough &amp; Stockton   71   71
##   Oxford                     66   66
##   Poole                      24   24</code></pre>
<p><strong>Here’s the pre-prepared and joined price and employment data, if you skipped the last chunk:</strong></p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="iteration.html#cb223-1" aria-hidden="true" tabindex="-1"></a>avpriceplusemp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;data/avpriceplusemp.rds&#39;</span>)</span></code></pre></div>
<hr />
<p>So: <strong>the aim is to do a regression of house price on employment for each TTWA, using its wards as data points.</strong> Before attempting multiple regressions, though, let’s <strong>work through a single regression</strong> to see what needs to happen.</p>
<p>We’ll be using <strong>log of house price</strong> as the dependent variable and using this to tell us about <strong>percentage change</strong>. And we’ll even use <strong>R’s base plotting function to quickly look at it.</strong></p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="iteration.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co">#test a single regression, look at plot.</span></span>
<span id="cb224-2"><a href="iteration.html#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Pull out a single year and TTWA</span></span>
<span id="cb224-3"><a href="iteration.html#cb224-3" aria-hidden="true" tabindex="-1"></a>testinz <span class="ot">&lt;-</span> avpriceplusemp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2001</span>, ttwa <span class="sc">==</span> <span class="st">&#39;Bradford&#39;</span>)</span>
<span id="cb224-4"><a href="iteration.html#cb224-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-5"><a href="iteration.html#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="co">#run the regression and look at a summary - log of house price as </span></span>
<span id="cb224-6"><a href="iteration.html#cb224-6" aria-hidden="true" tabindex="-1"></a>rez <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">data =</span> testinz, <span class="at">formula =</span> <span class="fu">log</span>(meanprice) <span class="sc">~</span> percentEmployed)</span>
<span id="cb224-7"><a href="iteration.html#cb224-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rez)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = log(meanprice) ~ percentEmployed, data = testinz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.27890 -0.16621  0.02439  0.13770  0.31521 
## 
## Coefficients:
##                 Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     4.804860   0.760030   6.322 5.69e-07 ***
## percentEmployed 0.066004   0.008179   8.070 5.22e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.1921 on 30 degrees of freedom
## Multiple R-squared:  0.6846, Adjusted R-squared:  0.6741 
## F-statistic: 65.13 on 1 and 30 DF,  p-value: 5.223e-09</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="iteration.html#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Look at the data and the estimated regression line</span></span>
<span id="cb226-2"><a href="iteration.html#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(testinz<span class="sc">$</span>meanprice) <span class="sc">~</span> testinz<span class="sc">$</span>percentEmployed)</span>
<span id="cb226-3"><a href="iteration.html#cb226-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(rez)</span></code></pre></div>
<p><img src="02_viz_n_wrangling_files/figure-html/unnamed-chunk-144-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>In Bradford in 2001, an employment increase of 1% was associated with a house price increase of about 6.6%.</p>
<p>But how to get the coefficients out of the ugly table and into a lovely graph? You’ll have to work this out for whatever model type you use, but for <strong>lm</strong> it looks like this. Read the comments…</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="iteration.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get a model summary object</span></span>
<span id="cb227-2"><a href="iteration.html#cb227-2" aria-hidden="true" tabindex="-1"></a>rezsummary <span class="ot">&lt;-</span> <span class="fu">summary</span>(rez)</span>
<span id="cb227-3"><a href="iteration.html#cb227-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-4"><a href="iteration.html#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Some things like R-squared are easily accessible... </span></span>
<span id="cb227-5"><a href="iteration.html#cb227-5" aria-hidden="true" tabindex="-1"></a>rezsummary<span class="sc">$</span>r.squared</span></code></pre></div>
<pre><code>## [1] 0.6846464</code></pre>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="iteration.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co">#But we want the slope coefficient and standard error.</span></span>
<span id="cb229-2"><a href="iteration.html#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Coefficients are stored in a matrix...</span></span>
<span id="cb229-3"><a href="iteration.html#cb229-3" aria-hidden="true" tabindex="-1"></a>rezsummary<span class="sc">$</span>coefficients</span></code></pre></div>
<pre><code>##                   Estimate  Std. Error  t value     Pr(&gt;|t|)
## (Intercept)     4.80485956 0.760030304 6.321932 5.690004e-07
## percentEmployed 0.06600402 0.008178535 8.070397 5.223239e-09</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="iteration.html#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co">#... so we just reference using row and column position to get them:</span></span>
<span id="cb231-2"><a href="iteration.html#cb231-2" aria-hidden="true" tabindex="-1"></a>rezsummary<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">1</span>] <span class="co"># coefficient for employment </span></span></code></pre></div>
<pre><code>## [1] 0.06600402</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="iteration.html#cb233-1" aria-hidden="true" tabindex="-1"></a>rezsummary<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">2</span>] <span class="co"># standard error</span></span></code></pre></div>
<pre><code>## [1] 0.008178535</code></pre>
<p>Now we know <strong>where to find the coefficients and standard errors</strong> all that needs to happen is: <strong>find a way to repeatedly run the model for each TTWA.</strong></p>
<p>We’ve already used a <strong>for loop</strong> to iterate over a process. R has a few other methods for iterating over groups of objects - and again the <strong>tidyverse</strong> provides a really neat version: the <strong>map</strong> function from the <strong>purrr</strong> library.</p>
<p>Since we’ve already used <strong>summarise</strong>, this is a good way to think about how <strong>map</strong> works. The notation is lengthy to explain - check the <strong>R for data science</strong> book if you want to know more. But this allows us to pull out the price means from each TTWA into a variable (of `double’ format, i.e. can have good decimal precision).</p>
<blockquote>
<p><strong>Note: split is a base-R function that <em>splits</em> a dataframe into a bunch of dataframes, based on the category passed in. So this is splitting the sales dataframe into smaller ones for each TTWA.</strong></p>
</blockquote>
<p><strong>The purrr library should be already loaded as part of the tidyverse library.</strong></p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="iteration.html#cb235-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> sales <span class="sc">%&gt;%</span> </span>
<span id="cb235-2"><a href="iteration.html#cb235-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>ttwa) <span class="sc">%&gt;%</span> </span>
<span id="cb235-3"><a href="iteration.html#cb235-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span><span class="fu">mean</span>(.<span class="sc">$</span>price))</span>
<span id="cb235-4"><a href="iteration.html#cb235-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-5"><a href="iteration.html#cb235-5" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>##                Blackburn                 Bradford                 Brighton 
##                 74787.08                 78759.26                186405.66 
##                Cambridge                Doncaster                     Hull 
##                189188.19                 76228.50                 85228.74 
##                   London Middlesbrough &amp; Stockton                   Oxford 
##                277824.28                 89690.92                208710.30 
##                    Poole 
##                189531.80</code></pre>
<p>The notation used makes it very easy to create tidy iterations. And here, we can break down the process of running many models and pulling out the numbers of interest <strong>using exactly the same approach we just used to get those means</strong>. First, <strong>running a linear model on each TTWA for 2001</strong>. Note we combine map with the <strong>dplyr filter</strong> verb.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="iteration.html#cb237-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> avpriceplusemp <span class="sc">%&gt;%</span> </span>
<span id="cb237-2"><a href="iteration.html#cb237-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2001</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb237-3"><a href="iteration.html#cb237-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>ttwa) <span class="sc">%&gt;%</span> </span>
<span id="cb237-4"><a href="iteration.html#cb237-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span><span class="fu">lm</span>(<span class="fu">log</span>(meanprice) <span class="sc">~</span> percentEmployed, <span class="at">data =</span> .))</span></code></pre></div>
<p>And to check we can now use those models to access the coefficients in the way we previously worked out:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="iteration.html#cb238-1" aria-hidden="true" tabindex="-1"></a>models <span class="sc">%&gt;%</span> </span>
<span id="cb238-2"><a href="iteration.html#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span> </span>
<span id="cb238-3"><a href="iteration.html#cb238-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span>.<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">1</span>])</span></code></pre></div>
<pre><code>##                Blackburn                 Bradford                 Brighton 
##               0.11050658               0.06600402               0.02570804 
##                Cambridge                Doncaster                     Hull 
##               0.09532273               0.12828774               0.08965422 
##                   London Middlesbrough &amp; Stockton                   Oxford 
##               0.03491091               0.07675510               0.06060024 
##                    Poole 
##               0.10562224</code></pre>
<p><strong>Tick!</strong> Great. Now what? Well, <strong>we can use this repeatedly to directly create a dataframe.</strong> So using the check code we just tested and two others, the following code does this:</p>
<ul>
<li><strong>Creates a dataframe of coefficients and standard errors (and pulls out the TTWA names in the process)</strong></li>
<li><strong>Uses mutate to multiply the coefficients by 100 to give percentages</strong></li>
<li><strong>Then uses mutate again to create a 95% confidence interval using the standard error</strong></li>
</ul>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="iteration.html#cb240-1" aria-hidden="true" tabindex="-1"></a>alloutput <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb240-2"><a href="iteration.html#cb240-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-3"><a href="iteration.html#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">names =</span> models <span class="sc">%&gt;%</span> </span>
<span id="cb240-4"><a href="iteration.html#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span> </span>
<span id="cb240-5"><a href="iteration.html#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dbl</span>(<span class="sc">~</span>.<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">1</span>]) <span class="sc">%&gt;%</span> names,</span>
<span id="cb240-6"><a href="iteration.html#cb240-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-7"><a href="iteration.html#cb240-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coeffs =</span> models <span class="sc">%&gt;%</span> </span>
<span id="cb240-8"><a href="iteration.html#cb240-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span> </span>
<span id="cb240-9"><a href="iteration.html#cb240-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span>.<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">1</span>]),</span>
<span id="cb240-10"><a href="iteration.html#cb240-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-11"><a href="iteration.html#cb240-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">se =</span> models <span class="sc">%&gt;%</span> </span>
<span id="cb240-12"><a href="iteration.html#cb240-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span> </span>
<span id="cb240-13"><a href="iteration.html#cb240-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span>.<span class="sc">$</span>coefficients[<span class="dv">2</span>,<span class="dv">2</span>])</span>
<span id="cb240-14"><a href="iteration.html#cb240-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-15"><a href="iteration.html#cb240-15" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb240-16"><a href="iteration.html#cb240-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-17"><a href="iteration.html#cb240-17" aria-hidden="true" tabindex="-1"></a><span class="co">#Multiply by 100</span></span>
<span id="cb240-18"><a href="iteration.html#cb240-18" aria-hidden="true" tabindex="-1"></a>alloutput <span class="ot">&lt;-</span> alloutput <span class="sc">%&gt;%</span> </span>
<span id="cb240-19"><a href="iteration.html#cb240-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb240-20"><a href="iteration.html#cb240-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">coeffs =</span> coeffs <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb240-21"><a href="iteration.html#cb240-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> se <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb240-22"><a href="iteration.html#cb240-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb240-23"><a href="iteration.html#cb240-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-24"><a href="iteration.html#cb240-24" aria-hidden="true" tabindex="-1"></a><span class="co">#add in some min/max confidence intervals from standard error</span></span>
<span id="cb240-25"><a href="iteration.html#cb240-25" aria-hidden="true" tabindex="-1"></a>alloutput <span class="ot">&lt;-</span> alloutput <span class="sc">%&gt;%</span> </span>
<span id="cb240-26"><a href="iteration.html#cb240-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb240-27"><a href="iteration.html#cb240-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">minn =</span> coeffs <span class="sc">-</span> (se <span class="sc">*</span> <span class="fl">1.96</span>),</span>
<span id="cb240-28"><a href="iteration.html#cb240-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxx =</span> coeffs <span class="sc">+</span> (se <span class="sc">*</span> <span class="fl">1.96</span>)</span>
<span id="cb240-29"><a href="iteration.html#cb240-29" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>As always, <strong>take a look at the resulting dataframe.</strong> We’ve got everything we need to plot. But notice the new thing here:</p>
<blockquote>
<p><strong>geom_errorbar takes in values for ymin and ymax from the data</strong>: these geoms in ggplot are <strong>not</strong> doing any of their own stats - you need to supply the mins and maxes directly, which is why we calculated them. (This gives us a lot more flexibility about what we want to show.)</p>
</blockquote>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="iteration.html#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(alloutput, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_reorder</span>(names,<span class="sc">-</span>coeffs), <span class="at">y =</span> coeffs)) <span class="sc">+</span></span>
<span id="cb241-2"><a href="iteration.html#cb241-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb241-3"><a href="iteration.html#cb241-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> minn, <span class="at">ymax =</span> maxx), <span class="at">width =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb241-4"><a href="iteration.html#cb241-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="02_viz_n_wrangling_files/figure-html/unnamed-chunk-151-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As a last exercise: <strong>how would you go about running the models for both decades and then comparing?</strong> The aim, as with all <strong>ggplots</strong>, would be to have <strong>year in its own column</strong> so it can be mapped to an aesthetic. You could also use <strong>dodge</strong>.</p>
<p>You could just re-run the code above, changing the year in <strong>filter</strong> to 2011. But another option is to <strong>turn the above code into a function</strong>. Doing this provides another way of iterating your code. Some points on functions:</p>
<ul>
<li><strong>As we’ve already said, R is a functional language: everything is a function, and they can all be composed together in whatever way produces valid output.</strong></li>
<li>Functions are just <strong>input/output machines</strong>: you just need to tell it what goes in and what you want out.</li>
</ul>
<p>A basic function might look like this. This is obviously a trivial example but the idea applies to anything more complex - the structure of writing one is exactly the same. Say we want to know: is a number divisible by two? (As if this isn’t obvious, but this illustrates the principle!)</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="iteration.html#cb242-1" aria-hidden="true" tabindex="-1"></a>isDivisibleByTwo <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb242-2"><a href="iteration.html#cb242-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-3"><a href="iteration.html#cb242-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Use R&#39;s modulus operator %% - gives the remainder from dividing by a number</span></span>
<span id="cb242-4"><a href="iteration.html#cb242-4" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> x <span class="sc">%%</span> <span class="dv">2</span></span>
<span id="cb242-5"><a href="iteration.html#cb242-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-6"><a href="iteration.html#cb242-6" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(result <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)</span>
<span id="cb242-7"><a href="iteration.html#cb242-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-8"><a href="iteration.html#cb242-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#We could also do this as the remainder from 2 is only 1 or 0</span></span>
<span id="cb242-9"><a href="iteration.html#cb242-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and R interprets 1 and 0 as TRUE and FALSE</span></span>
<span id="cb242-10"><a href="iteration.html#cb242-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#return(!as.logical(x))</span></span>
<span id="cb242-11"><a href="iteration.html#cb242-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-12"><a href="iteration.html#cb242-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#By default, an R function will return the last created variable. </span></span>
<span id="cb242-13"><a href="iteration.html#cb242-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Or you can tell it explicitly what to return like this.</span></span>
<span id="cb242-14"><a href="iteration.html#cb242-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb242-15"><a href="iteration.html#cb242-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-16"><a href="iteration.html#cb242-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You then need to highlight the whole code block and run it, as usual. Nothing will happen - except <strong>you’ll now see the function name in the environment panel.</strong></p>
<p>Once that’s done, your new in-out machine should work:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="iteration.html#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isDivisibleByTwo</span>(<span class="dv">46</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="iteration.html#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isDivisibleByTwo</span>(<span class="dv">127</span>)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>The principle of building functions is simple: <strong>where possible, put what doesn’t change into a function, pass what <em>does</em> change as <em>arguments</em> to the function.</strong> In this simple case, it’s our number we want dividing by two that changes. (Note: the name of the variable is arbitrary: whatever you pass in will be assigned to it.)</p>
<blockquote>
<p><strong>So: how would you apply this to the model-running code? Here are some ideas.</strong></p>
</blockquote>
<ul>
<li>The only thing that changes is the year: it’s either 2001 or 2011. Everything else can be the same as the code used above.</li>
<li>All of this code could go inside the function:
<ul>
<li>The first <strong>models &lt;- avpriceplusemp</strong> code, where currently year is set to either 2001 or 2011. It’s here we’d use the value passed into the function.</li>
<li>Then the code creating the <strong>alloutput</strong> dataframe. This is the thing we want the function to return.</li>
</ul></li>
</ul>
<p>There would also be nothing wrong with adding the extra year column in the function itself - but you would need that for creating <strong>a single year column</strong> that ggplot can use to map to an aesthetic.</p>
<blockquote>
<p><strong>Note: you can view a working version of this function in the file containing all the code, in the project folder, if you want to see how it’s put together to help write your own / cheat!</strong></p>
</blockquote>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="iteration.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Pass a year into the function, then add a column to mark the year.</span></span>
<span id="cb247-2"><a href="iteration.html#cb247-2" aria-hidden="true" tabindex="-1"></a>model01 <span class="ot">&lt;-</span> <span class="fu">modelz</span>(<span class="dv">2001</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2001</span>)</span>
<span id="cb247-3"><a href="iteration.html#cb247-3" aria-hidden="true" tabindex="-1"></a>model11 <span class="ot">&lt;-</span> <span class="fu">modelz</span>(<span class="dv">2011</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2011</span>)</span>
<span id="cb247-4"><a href="iteration.html#cb247-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-5"><a href="iteration.html#cb247-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Both will be the same structure - combine the rows from both</span></span>
<span id="cb247-6"><a href="iteration.html#cb247-6" aria-hidden="true" tabindex="-1"></a>bothmodels <span class="ot">&lt;-</span> <span class="fu">rbind</span>(model01,model11)</span></code></pre></div>
<p>And with the addition of <strong>position = ‘dodge’</strong> in <strong>geom_errorbar</strong>, this could be used to create the following. Note here we’re setting <strong>dodge spacing</strong> directly so we can control the point <strong>and</strong> error bar position to both match each other:</p>
<p><img src="02_viz_n_wrangling_files/figure-html/unnamed-chunk-155-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Again, the <strong>R for Data Science</strong> book has a lot more on functional programming - hopefully this gives a hint of its power.</p>
<hr />
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="facetting-and-dodging-getting-as-much-info-into-one-graph-as-humanly-possible.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="a-little-bit-of-mapping.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
